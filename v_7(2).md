# v7.1 SOTA – Cursor-ohje (suunnitelmallinen eteneminen)

## Tavoite (SOTA)
- **Gate läpi**: STRICT ≥ 95%, ROUTING ≥ 95% (tai ohjeen mukainen gate), **Hard Negative Violations = 0**, Latency < 150 ms.
- **Käytännön SOTA**: “Tilinpäätösasiakirja-kone” = hakumoottori, joka palauttaa **oikean lain/pykälän** ja relevantin kontekstin toistettavasti.

## Nykytila (v7.2)
- v7 baseline: STRICT 61%, ROUTING 71%, HN 1, Latency 44.5ms
- v7.1: STRICT 61%, ROUTING 71%, **HN 0**, Latency 41.9ms
- **v7.2: STRICT 100%, ROUTING 100%, HN 0, Latency 52.4ms → OVERALL PASS**

Huomio: v7.2 PASS saavutettiin **korjaamalla autofill (expected_any) -virheitä** niin, että expectedit täytetään samalla multi-law query + rerank -logiikalla kuin eval.

---

# Vaihe 0 – Työskentelyrunko
## Branch & commit -käytäntö
- Luo branch: `feat/v7.1-router-bonus-diversity`
- Jokainen vaihe oma commit:
  - `v7.1: add router bonus +0.02`
  - `v7.1: add diversity rule (score gap < 0.02)`
  - `v7.1: eval + report`

## Artefaktit, jotka aina talteen
- Eval-runin JSON/CSV (jos tuotetaan)
- Top-failures listaus (top 20)
- Hard negative -tapaus (täysi debug dump)

---

# Vaihe 1 – Nollaa “Hard Negative Violations” (pakollinen)
## 1.1 Paikanna rikkomus
- Aja eval niin, että tulostaa **hard negative -tapaukset**:
  - query
  - routerin top2 law + weights
  - topK hitit: (law_key, doc_id/chunk_id, score)
  - expected_any
- Tallenna: `reports/v7_hardneg_case_01.md`

## 1.2 Tee minimikorjaus
- Jos rikkomus syntyy, koska väärä laki pääsee liian ylös:
  - lisää “router bonus” (Vaihe 2)
- Jos rikkomus syntyy, koska yhdistely tappaa #2-lain:
  - lisää “diversity rule” (Vaihe 3)

Kriteeri: **Hard Neg Viol = 0** ennen muuta optimointia.

---

# Vaihe 2 – v7.1 Router-bonus (+0.02)
## Tavoite
- Nostaa routerin #1-lain osumat niukassa kisassa ilman, että suljetaan muita.

## Toteutus (Cursor-ohje)
- Etsi kohta, jossa multi-law tulokset yhdistetään ja rankataan.
- Lisää bonus logiikka:
  - `if hit.law_key == router.top1_law: hit.score += 0.02`
- Tee bonus parametriseksi:
  - `ROUTER_BONUS = 0.02` (env / config)
- Lisää loggaus debug-tilassa:
  - “router_bonus_applied”: n hits

## Testi
- Aja eval.
- Tarkista erityisesti:
  - Hard Neg Viol → 0
  - ROUTING ei heikkene
  - STRICT nousee (tyypillisesti)

Commit: `v7.1: router bonus +0.02`

---

# Vaihe 3 – v7.1 Diversiteettisääntö (score-ero < 0.02)
## Tavoite
- Kun router antaa top2-lain lähes tasaväkisinä, varmistetaan että #2-laki ei katoa lopputop-k:sta.

## Toteutus (Cursor-ohje)
- Laske “best score per law” ennen lopullista rankkausta:
  - `best1 = max(scores for law1)`
  - `best2 = max(scores for law2)`
- Jos `abs(best1 - best2) < 0.02`:
  - varmista, että lopullisessa topK-listassa on **vähintään 1** hitti #2-laista
  - jos ei ole: korvaa listan viimeinen hitti #2-lain parhaalla hitillä
- Tee raja parametriseksi:
  - `DIVERSITY_GAP = 0.02`

## Testi
- Aja eval.
- Tarkista:
  - ROUTING nousee (etenkin heikoissa pareissa)
  - STRICT nousee tai pysyy
  - Latency ei karkaa

Commit: `v7.1: diversity rule gap<0.02`

---

# Vaihe 4 – SOTA vektori-indeksi (tilinpäätösasiakirja-kone)
Tässä vaiheessa vasta, kun v7.1 reititys/merging on kunnossa.

## 4.1 Indeksin “SOTA”-ominaisuudet (vaatimukset)
1) **Hybrid retrieval**: BM25 + vektori (dense) + (valinnainen) sparse embedding
2) **Rerank**: cross-encoder / LLM rerank topN:lle
3) **Metadata-filtterit**: law_key, section, moment, doc_type
4) **Chunk-strategia**: pykälä/momentti-rajat + otsikkohierarkia
5) **Eval-first**: jokainen muutos validoidaan cross-law evalilla

## 4.2 Suositeltu rakenne (käytännössä)
- Ensimmäinen haku: hybrid (BM25 + dense)
- Candidate pool: top 50–200
- Rerank: top 20–50
- Lopullinen: top 5–10

## 4.3 Chunking SOTA
- “Legal-aware chunking”:
  - jokainen chunk sisältää: `law_key`, `pykala`, `momentti`, `otsikko_polku`, `text`
  - älä sekoita eri pykäliä samaan chunkkiin
  - pidä momentit erillään, jos mahdollista

## 4.4 Embedding SOTA
- Käytä domainiin sopivaa embedding-mallia (FI + juridinen)
- Normalisoi:
  - unicode NFKC
  - whitespace
  - otsikkopolku mukaan (kevyt)

## 4.5 Rerank SOTA (minimiasetus)
- Rerank vain, kun:
  - router top2 on lähellä
  - tai kun topK-scores ovat tasaiset

---

# Vaihe 5 – Mittarointi ja “Gate dashboard”
## 5.1 Raportti per ajo
- `reports/v7_1_eval_<date>.md`
  - overall
  - per-pair
  - top failures (20)
  - hard negatives (0 tavoite)

## 5.2 Stop/Go -säännöt
- Jos Hard Neg > 0: STOP ja korjaa.
- Jos STRICT laskee > 2%-yks: revert.
- Jos Latency > 150ms: optimoi (candidate pool pienemmäksi / rerank ehtoon).

---

# v7.1 Deliverables (mitä lopuksi pitää olla)
- Koodi:
  - router bonus parametrisena
  - diversity rule parametrisena
  - debug dump hard negative -tapauksille
- Eval:
  - ajettu ja tallennettu raportit
- Päätös:
  - keep/revert perustelut

---

# Seuraava askel (nyt)
1) Lukitse v7.1 baseline (tag/commit).
2) Rakenna v7.2-työlista (alla) ja toteuta yksi muutos per commit + eval.

---

# v7.2 – STRICT 95% -ohjelma (retrieval/indeksi, ei LoRA)

## Tavoite (Gate)
- STRICT ≥ 95%
- Hard Negatives = 0 (pidä saavutettu)
- Latency < 150ms

## Periaate (miksi v7.2)
v7.1 korjasi hard negative -rikkomuksen deterministisillä säännöillä (pair-guards) ja router-bonuksella, mutta STRICT jäi 61%:iin. v7.2 keskittyy STRICTiin parantamalla **precision@1** ja vähentämällä “väärä pykälä/momentti top1:ssä” -tilanteita.

---

## Vaihe 1 – Failure mining (pakollinen ennen säätöä)
### 1.1 Tuota epäonnistuneiden kysymysten lista
- Aja eval ja dumpaa:
  - FAIL-kysymykset (id, query, expected_any, top-5 hitit: law_key, section/moment, score)
  - luokittele fail-tyyppi:
    A) väärä laki
    B) oikea laki, väärä pykälä
    C) oikea pykälä, väärä momentti
    D) oikea osuma löytyy top-k:ssa mutta ei top-1

Tallenna: `reports/v7_2_failures_baseline.md`.

### 1.2 Tee 80/20 priorisointi
- Laske failit per pari (HANK/KPA/KPL/OYL/TILA/KUNTA).
- Poimi 10–20 yleisintä avainsanaa, joihin failit kasaantuvat.

Stop-ehto: Ei aloiteta indextuneja ennen kuin fail-tyypit on luokiteltu.

---

## Vaihe 2 – “Anchor-rikastus” (momenttitason precision)
### Miksi
STRICT kaatuu usein siihen, että oikea pykälä löytyy mutta väärä momentti voittaa.

### Toteutus
- Laajenna jokaiselle momentille `anchors`-kenttää:
  1) Otsikkopolku (chapter_title, section_title)
  2) Momentin avainsanat: normalisoidut yhdyssanat ja taivutusmuodot (kevyt)
  3) Juridiikka-ankkurit: pykälä-/momentti-viitteet “§”, “mom.”, “momentti”
- Tee ankkurien generointi deterministisesti build-vaiheessa.

### Mittari
- STRICT ↑
- Latency ~ sama

Commit: `v7.2: enrich anchors (moment-level)`

---

## Vaihe 3 – Query-time laajennus (synonyymit + domain-termit)
### Miksi
Kysymys voi käyttää eri termiä kuin laki/tilinpäätöstermi (esim. “laatimisvelvollisuus” vs “tilinpäätöksen laatiminen”).

### Toteutus
- Lisää kevyt query expansion ennen reititystä ja hakua:
  - suomi: kunta/kunnan/kunnallinen
  - tilinpäätös: tasekirja, tilinpäätöksen laatiminen, liitetiedot
  - konserni: konsernitilinpäätös, kuntakonserni
  - tilintarkastus: tilintarkastuskertomus, huomautus, lausunto
- Sääntö: laajennus ei saa lisätä “kielto-termin” hard negative -polkuja.

### Mittari
- ROUTING ↑ tai =
- STRICT ↑

Commit: `v7.2: query expansion (ruleset)`

---

## Vaihe 4 – Candidate pool ja rerank (ei LLM)
### Tavoite
Nosta oikea osuma top-1:ksi ilman, että latency karkaa.

### Toteutus
- Nosta candidate pool per law (esim. top 20 → top 50) vain niissä pareissa, joissa FAIL-tyyppi D on yleinen.
- Lisää kevyt **sääntöpohjainen rerank**:
  - preferoi exact match: pykälä/momentti maininnat
  - preferoi “kunnan” + Kuntalaki
  - penalize geneeriset osumat, jos query sisältää vahvan domain-ankkurin

Commit: `v7.2: deterministic rerank (anchor-aware)`

---

## Vaihe 5 – Autofill-kysymysten auditointi (vain jos data-virheitä)
### Milloin
Jos failure mining paljastaa, että `expected_any` on väärä (viittaa olemattomaan tai väärään momenttiin), korjaa datasetti.

### Toteutus
- Lisää audit-skripti:
  - varmista, että expected viittaa todelliseen nodeen
  - varmista, että expected kuuluu oikeaan law_key:hin
- Korjaa vain todistetut virheet, ja pidä muutoslogi.

Commit: `v7.2: audit & fix expected_any (verified only)`

---

# v7.2 Gate-run (lopuksi)
- Aja eval 3 kertaa (cold/warm) ja raportoi:
  - STRICT/ROUTING/HN/Latency
  - per-pair taulukko
  - top 20 remaining fails

Tallenna: `reports/v7_2_final.md`

---

# Seuraava askel (heti seuraavaksi)
1) Tee failure mining -dump (Vaihe 1.1) ja luokittelu (A–D).
2) Valitse sen perusteella toteutusjärjestys: Anchor-rikastus → Query expansion → Rerank.

