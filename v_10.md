# v10.1 – Metrics Contract & Single‑Source Reporting (Adversarial Eval)

## Tavoite
Poistaa **ristiriidat raportoinnista** ja lukita v10-adversarial-evalin totuus yhteen paikkaan.

v10.1 määrittelee:
- **yksiselitteisen metrics‑sopimuksen** (mikä on FAIL, mikä PASS)
- **yhden totuuden lähteen** (JSON)
- **deterministisen raporttigeneraattorin** (ei rinnakkaislaskentaa)

Ilman tätä v10 ei ole luotettava gate.

---

## 1) Single Source of Truth

### 1.1 Ainoa totuus
`reports/v10_adversarial_results.json`

Kaikki muu (summary.md, failures.md, README‑luvut) **generoidaan tästä tiedostosta**.

KIELLETTYÄ:
- laskea metriikoita erikseen summary‑ ja failures‑skripteissä
- tulkita “pass rate” käsin

---

## 2) Case‑tason totuussäännöt

Jokaiselle testicase‑riville (JSON):

### 2.1 Pakolliset kentät
- `case_id`
- `category`
- `top1_law_key`
- `topk_law_keys`
- `confusion_fail` (bool)
- `hallucinated_evidence` (bool)
- `version_drift` (bool)
- `system_abstains` (bool)
- `abstain_expected` (bool)

---

### 2.2 Case PASS / FAIL ‑logiikka (lukittu)

```text
CASE_FAIL jos yksikin toteutuu:
- hallucinated_evidence == true
- version_drift == true
- (confusion_fail == true AND category != ABSTAIN)
- (abstain_expected == true AND system_abstains == false)

CASE_PASS muuten
```

HUOM:
- CONFUSION_FAIL EI voi “passata” top‑k:lla
- ABSTAIN‑casessa oikea abstain = PASS

---

## 3) Gate‑tason metriikat (v10.1)

### 3.1 Päägatet (FAIL jos yksikin rikkoontuu)

| Gate | Laskenta | Raja |
|-----|---------|------|
| CONFUSION_FAIL_RATE | confusion_fail / total_non_abstain | ≤ 2% |
| HALLU_EVIDENCE | count | = 0 |
| VERSION_DRIFT | count | = 0 |
| ABSTAIN_CORRECT | correct_abstain / expected_abstain | ≥ 90% |

---

### 3.2 Informatiiviset metriikat (ei gate)
- PASS_RATE
- NEAR_MISS
- TOP5_COVERAGE
- AVG_LATENCY

NÄITÄ EI SAA käyttää “100% PASS” ‑väitteeseen.

---

## 4) Raporttigeneraattori (pakollinen rakenne)

### 4.1 Script
`scripts/render_v10_report.py`

### 4.2 Input
- `reports/v10_adversarial_results.json`

### 4.3 Output
- `reports/v10_adversarial_summary.md`
- `reports/v10_adversarial_failures.md`
- (optionaalinen) `reports/v10_adversarial_metrics.csv`

Kaikki numerot johdetaan **yhdestä JSON‑ajosta**.

---

## 5) Summary.md – Pakollinen formaatti

```md
# v10 Adversarial Eval – Summary

## Gates
- CONFUSION_FAIL_RATE: 0% (PASS)
- HALLU_EVIDENCE: 0 (PASS)
- VERSION_DRIFT: 0 (PASS)
- ABSTAIN_CORRECT: 100% (PASS)

## Overall verdict
OVERALL: PASS

## Info metrics
- Pass rate: 100%
- Near misses: 0
- Avg latency: 102 ms
```

Jos yksikin gate FAIL → **OVERALL: FAIL**.

---

## 6) Failures.md – Pakollinen sisältö

Listaa VAIN `CASE_FAIL == true`:

| Case | Category | Reason |
|-----|---------|--------|
| ADV‑LAW‑001 | LAW | confusion_fail (top1 wrong law) |

Ei “melkein oikein” ‑tapauksia.

---

## 7) README‑päivityssääntö

README:ssa SAA lukea vain:
- gate‑tila (PASS/FAIL)
- gate‑metriikat

KIELLETTYÄ:
- “100% PASS” jos yksikin gate on FAIL
- yhdistää pass rate + gate yhdeksi numeroksi

---

## 8) CI‑lukitus

PR FAIL jos:
- v10.1 gate FAIL
- raportit eivät täsmää JSON‑tulokseen

---

## 9) Seuraava askel (nyt)

1) Toteuta `render_v10_report.py`
2) Poista vanhat summary/failure‑laskennat
3) Aja v10 uudelleen
4) Taggaa **v10.1.0** vasta kun OVERALL = PASS

